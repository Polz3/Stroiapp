{% extends "base.html" %}
{% block title %}–†–∞—Å—Ö–æ–¥—ã ‚Äî –°—Ç—Ä–æ–π–ö–æ–Ω—Ç—Ä–æ–ª—å{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">–†–∞—Å—Ö–æ–¥—ã –∏ –ó–∞—Ä–ø–ª–∞—Ç—ã</h2>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="row g-3 align-items-center mb-3">
    <div class="col-auto">
      <select id="siteFilter" class="form-select bg-dark text-white border-0">
        <option value="">–í—Å–µ –æ–±—ä–µ–∫—Ç—ã</option>
      </select>
    </div>
    <div class="col-auto">
      <select id="typeFilter" class="form-select bg-dark text-white border-0">
        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
        <option value="purchase">–ó–∞–∫—É–ø–∫–∞</option>
        <option value="salary">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
      </select>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö -->
  <div id="expensesList"></div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  let allExpenses = [];

  function showProblem(msg) {
    const c = document.getElementById("expensesList");
    c.innerHTML = `<div class="alert alert-danger">${msg}</div>`;
    console.error(msg);
  }

  async function loadExpenses() {
    try {
      const response = await authorizedFetch('/api/expenses');
      if (response.status === 401) {
        window.location.href = "/login";
        return;
      }
      if (!response.ok) {
        showProblem(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ /api/expenses: ${response.status} ${response.statusText}`);
        return;
      }
      allExpenses = await response.json();
      renderExpenses();
    } catch (e) {
      showProblem(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å /api/expenses: ${e}`);
    }
  }

  async function loadSites() {
    try {
      const response = await authorizedFetch('/api/sites');
      if (response.status === 401) {
        window.location.href = "/login";
        return;
      }
      if (!response.ok) {
        showProblem(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ /api/sites: ${response.status} ${response.statusText}`);
        return;
      }
      const sites = await response.json();
      const filter = document.getElementById("siteFilter");
      sites.forEach(site => {
        const opt = document.createElement("option");
        opt.value = site.id;
        opt.textContent = site.name;
        filter.appendChild(opt);
      });
    } catch (e) {
      showProblem(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å /api/sites: ${e}`);
    }
  }

  function renderExpenses() {
    const siteId = document.getElementById("siteFilter").value;
    const type = document.getElementById("typeFilter").value;
    const container = document.getElementById("expensesList");
    container.innerHTML = "";

    const filtered = allExpenses.filter(e => {
      if (siteId && String(e.site_id) !== String(siteId)) return false;
      if (type && e.type !== type) return false;
      return true;
    });

    if (!filtered.length) {
      container.innerHTML = "<p class='text-muted'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>";
      return;
    }

    // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
    const grouped = {};
    for (const e of filtered) {
      const raw = (e.date ?? "").toString();
      const day = raw.includes("T") ? raw.split("T")[0] : raw;
      if (!grouped[day]) grouped[day] = [];
      grouped[day].push(e);
    }

    Object.keys(grouped).sort().reverse().forEach(date => {
      const group = grouped[date];
      const dayBlock = document.createElement("div");
      dayBlock.classList.add("mb-4");

      const title = document.createElement("h5");
      const d = new Date(date);
      title.textContent = isNaN(d) ? date : d.toLocaleDateString();
      dayBlock.appendChild(title);

      const list = document.createElement("ul");
      list.className = "list-group list-group-flush";

      group.sort((a, b) => (b.id ?? 0) - (a.id ?? 0)).forEach(item => {
        const li = document.createElement("li");
        li.className = "list-group-item bg-transparent text-white d-flex justify-content-between align-items-center";

        const amountNum = Number(item.amount);
        const amountText = Number.isFinite(amountNum) ? amountNum.toFixed(2) : String(item.amount ?? '');

        li.innerHTML = `
          <span>
            ${item.type === 'purchase' ? 'üõí' : 'üí∏'}
            ${item.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}
            ${item.site_name ? ` | ${item.site_name}` : ''}
          </span>
          <span class="fw-bold">${amountText} ‚ÇΩ</span>
        `;
        list.appendChild(li);
      });

      dayBlock.appendChild(list);
      container.appendChild(dayBlock);
    });
  }

  document.getElementById("siteFilter").addEventListener("change", renderExpenses);
  document.getElementById("typeFilter").addEventListener("change", renderExpenses);

  loadSites();
  loadExpenses();
});
</script>
{% endblock %}
